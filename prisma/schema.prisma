generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========== MASTER PROFILE TABLE ==========
// This links to Supabase Auth user ID and contains shared fields

model Profile {
  id        String   @id // Supabase Auth user ID
  email     String   @unique
  firstName String
  lastName  String
  phone     String?
  avatar    String?
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Role-specific relations (one-to-one)
  therapist Therapist?
  parent    Parent?
  admin     Admin?

  // System relations
  sessions  Session[]
  auditLogs AuditLog[]

  @@index([role])
  @@index([isActive])
  @@index([email])
  @@map("profiles")
}

// ========== ROLE-SPECIFIC TABLES ==========
// These tables ONLY contain role-specific information

model Therapist {
  id                   String   @id @default(uuid())
  profileId            String   @unique
  profile              Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  licenseNumber        String?  @unique
  bio                  String?
  isCoordinator        Boolean  @default(false) // Coordinador = super therapist
  canTakeConsultations Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  specialties           TherapistSpecialty[]
  schedules             TherapistSchedule[]
  consultationRequests  ConsultationRequest[]
  consultationForms     ConsultationForm[]
  therapeuticProposals  TherapeuticProposal[]
  proposalServices      ProposalService[]   @relation("ProposalServiceTherapist")
  serviceAssignments    ServiceAssignment[]
  patientSessions       PatientSession[]
  therapeuticPlans      TherapeuticPlan[]
  progressReports       ProgressReport[]
  finalReports          FinalReport[]

  @@index([profileId])
  @@index([isCoordinator])
  @@index([canTakeConsultations])
  @@index([licenseNumber])
  @@map("therapists")
}

model Parent {
  id               String   @id @default(uuid())
  profileId        String   @unique
  profile          Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  address          String?
  city             String?
  emergencyContact String?
  emergencyPhone   String?
  relationship     String? // padre, madre, tutor, etc.
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  patients              Patient[]
  consultationRequests  ConsultationRequest[]
  payments              Payment[]
  scheduleRequests      ScheduleRequest[]

  @@index([profileId])
  @@map("parents")
}

model Admin {
  id         String   @id @default(uuid())
  profileId  String   @unique
  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  department String? // Optional: which area they manage
  notes      String? // Optional: internal notes
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([profileId])
  @@map("admins")
}

// ========== USER ROLES ==========

enum UserRole {
  SUPER_ADMIN // Financial management, all user management
  ADMIN       // Secretary role, payment confirmation, schedule management
  COORDINATOR // Super therapist - manages therapists but IS a therapist
  THERAPIST   // Regular therapist
  PARENT      // Parent of patient

  @@map("user_roles")
}

// ========== REST OF SCHEMA (keeping your existing models) ==========

model Patient {
  id               String   @id @default(uuid())
  parentId         String
  parent           Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)
  firstName        String
  lastName         String
  dateOfBirth      DateTime
  gender           Gender
  schoolName       String?
  schoolGrade      String?
  medicalHistory   Json? // Structured medical history data
  specialNeeds     String? // Description of special needs
  emergencyContact String?
  emergencyPhone   String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  consultationRequests  ConsultationRequest[]
  medicalForms          MedicalForm[]
  therapeuticProposals  TherapeuticProposal[]
  patientSessions       PatientSession[]
  therapeuticPlans      TherapeuticPlan[]
  progressReports       ProgressReport[]
  finalReports          FinalReport[]
  documents             PatientDocument[]

  @@index([parentId])
  @@index([firstName, lastName])
  @@index([dateOfBirth])
  @@index([isActive])
  @@map("patients")
}

model Session {
  id        String   @id @default(uuid())
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  token     String   @unique
  ipAddress String?
  userAgent String?
  device    String?
  browser   String?
  os        String?
  country   String?
  city      String?
  lastActivityAt DateTime @default(now())
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model AuditLog {
  id         String   @id @default(uuid())
  profileId  String?
  profile    Profile? @relation(fields: [profileId], references: [id], onDelete: SetNull)
  action     String
  resource   String
  resourceId String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  success    Boolean  @default(true)
  errorMessage String?
  metadata   Json?
  category   String?
  createdAt  DateTime @default(now())

  @@index([profileId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([createdAt])
  @@index([category])
  @@map("audit_logs")
}

// Continue with all your existing therapy-related models...
// (Specialty, ConsultationReason, Service, etc.)
// I'm keeping them as-is since they don't need changes

model Specialty {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  therapists         TherapistSpecialty[]
  services           Service[]
  consultationReasons ConsultationReason[]

  @@index([name])
  @@index([isActive])
  @@map("specialties")
}

model ConsultationReason {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  specialtyId String
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  consultationRequests ConsultationRequest[]

  @@index([specialtyId])
  @@index([name])
  @@index([isActive])
  @@map("consultation_reasons")
}

// ... (rest of your models remain the same)
// I'll add placeholders for the ones you need

model TherapistSpecialty {
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  specialtyId String
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@id([therapistId, specialtyId])
  @@index([therapistId])
  @@index([specialtyId])
  @@map("therapist_specialties")
}

model TherapistSchedule {
  id                    String     @id @default(uuid())
  therapistId           String
  therapist             Therapist  @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  dayOfWeek             DayOfWeek
  startTime             String // HH:mm format
  endTime               String // HH:mm format
  breakStart            String? // HH:mm format
  breakEnd              String? // HH:mm format
  breakBetweenSessions  Int       @default(15) // minutes
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([therapistId, dayOfWeek])
  @@index([therapistId])
  @@index([dayOfWeek])
  @@index([isActive])
  @@map("therapist_schedules")
}

model Service {
  id              String      @id @default(uuid())
  code            String      @unique
  name            String
  description     String?
  type            ServiceType
  specialtyId     String
  specialty       Specialty   @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  defaultSessions Int
  costPerSession  Decimal     @db.Decimal(10, 2)
  sessionDuration Int // minutes
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  proposalServices   ProposalService[]
  serviceAssignments ServiceAssignment[]

  @@index([code])
  @@index([specialtyId])
  @@index([type])
  @@index([isActive])
  @@map("services")
}

model ConsultationRequest {
  id             String                   @id @default(uuid())
  parentId       String
  parent         Parent                   @relation(fields: [parentId], references: [id], onDelete: Cascade)
  patientId      String
  patient        Patient                  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  type           ConsultationType
  status         ConsultationStatus       @default(PENDING)
  scheduledDate  DateTime?
  scheduledTime  String? // HH:mm format
  therapistId    String?
  therapist      Therapist?               @relation(fields: [therapistId], references: [id], onDelete: SetNull)
  reasonId       String?
  reason         ConsultationReason?      @relation(fields: [reasonId], references: [id], onDelete: SetNull)
  cost           Decimal?                 @db.Decimal(10, 2)
  paymentStatus  PaymentStatus            @default(PENDING)
  paymentProof   String? // URL to uploaded file
  notes          String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  consultationForm     ConsultationForm?
  therapeuticProposal  TherapeuticProposal?

  @@index([parentId])
  @@index([patientId])
  @@index([therapistId])
  @@index([status])
  @@index([scheduledDate])
  @@index([paymentStatus])
  @@map("consultation_requests")
}

// Add remaining models from your schema...
model ConsultationForm {
  id                   String              @id @default(uuid())
  consultationRequestId String             @unique
  consultationRequest  ConsultationRequest @relation(fields: [consultationRequestId], references: [id], onDelete: Cascade)
  therapistId          String
  therapist            Therapist           @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  formData             Json // All form data
  diagnosis            String?
  observations         String?
  status               FormStatus          @default(DRAFT)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  @@index([consultationRequestId])
  @@index([therapistId])
  @@index([status])
  @@map("consultation_forms")
}

model MedicalForm {
  id         String     @id @default(uuid())
  patientId  String
  patient    Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  formData   Json // All medical form data
  filledBy   String // "parent" or "therapist"
  isComplete Boolean    @default(false)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([patientId])
  @@index([isComplete])
  @@map("medical_forms")
}

model TherapeuticProposal {
  id                    String              @id @default(uuid())
  consultationRequestId String              @unique
  consultationRequest   ConsultationRequest @relation(fields: [consultationRequestId], references: [id], onDelete: Cascade)
  patientId             String
  patient               Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId           String
  therapist             Therapist           @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  treatmentPeriod       TreatmentPeriod
  parentAvailability    Json // Availability schedule
  status                ProposalStatus      @default(DRAFT)
  coordinatorNotes      String?
  adminNotes            String?
  selectedProposal      ProposalType? // A or B
  paymentPlan           PaymentPlan?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  services             ProposalService[]
  therapeuticPlan      TherapeuticPlan?

  @@index([consultationRequestId])
  @@index([patientId])
  @@index([therapistId])
  @@index([status])
  @@map("therapeutic_proposals")
}

model ProposalService {
  id                      String              @id @default(uuid())
  therapeuticProposalId   String
  therapeuticProposal     TherapeuticProposal @relation(fields: [therapeuticProposalId], references: [id], onDelete: Cascade)
  serviceId               String
  service                 Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  therapistId             String
  therapist               Therapist           @relation("ProposalServiceTherapist", fields: [therapistId], references: [id], onDelete: Cascade)
  sessionsProposalA       Int
  sessionsProposalB       Int
  costPerSession          Decimal             @db.Decimal(10, 2)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  serviceAssignments ServiceAssignment[]

  @@index([therapeuticProposalId])
  @@index([serviceId])
  @@index([therapistId])
  @@map("proposal_services")
}

model ServiceAssignment {
  id                String          @id @default(uuid())
  proposalServiceId String
  proposalService   ProposalService @relation(fields: [proposalServiceId], references: [id], onDelete: Cascade)
  serviceId         String
  service           Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  therapistId       String
  therapist         Therapist       @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  numberOfSessions  Int
  status            AssignmentStatus @default(SCHEDULED)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  patientSessions PatientSession[]

  @@index([proposalServiceId])
  @@index([serviceId])
  @@index([therapistId])
  @@index([status])
  @@map("service_assignments")
}

model PatientSession {
  id                    String            @id @default(uuid())
  serviceAssignmentId   String
  serviceAssignment     ServiceAssignment @relation(fields: [serviceAssignmentId], references: [id], onDelete: Cascade)
  patientId             String
  patient               Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId           String
  therapist             Therapist         @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  scheduledDate         DateTime
  scheduledTime         String // HH:mm format
  duration              Int // minutes
  status                SessionStatus     @default(SCHEDULED)
  startedAt             DateTime?
  completedAt           DateTime?
  therapistNotes        String?
  observations          String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([serviceAssignmentId])
  @@index([patientId])
  @@index([therapistId])
  @@index([scheduledDate])
  @@index([status])
  @@map("patient_sessions")
}

model TherapeuticPlan {
  id                      String              @id @default(uuid())
  therapeuticProposalId   String              @unique
  therapeuticProposal     TherapeuticProposal @relation(fields: [therapeuticProposalId], references: [id], onDelete: Cascade)
  patientId               String
  patient                 Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId             String
  therapist               Therapist           @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  objectives              Json
  background              String?
  metrics                 Json
  recommendations         String?
  status                  ReportStatus        @default(DRAFT)
  coordinatorNotes        String?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  progressReports ProgressReport[]

  @@index([therapeuticProposalId])
  @@index([patientId])
  @@index([therapistId])
  @@index([status])
  @@map("therapeutic_plans")
}

model ProgressReport {
  id                String          @id @default(uuid())
  therapeuticPlanId String
  therapeuticPlan   TherapeuticPlan @relation(fields: [therapeuticPlanId], references: [id], onDelete: Cascade)
  patientId         String
  patient           Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId       String
  therapist         Therapist       @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  reportNumber      Int // 1st, 2nd, 3rd report
  metricsUpdate     Json
  progress          String?
  observations      String?
  status            ReportStatus    @default(DRAFT)
  coordinatorNotes  String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([therapeuticPlanId])
  @@index([patientId])
  @@index([therapistId])
  @@index([status])
  @@map("progress_reports")
}

model FinalReport {
  id              String       @id @default(uuid())
  patientId       String
  patient         Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId     String
  therapist       Therapist    @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  finalMetrics    Json
  conclusions     String?
  recommendations String?
  status          ReportStatus @default(DRAFT)
  coordinatorNotes String?
  coordinatorReport String? // Coordinator compiles all therapist reports
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([patientId])
  @@index([therapistId])
  @@index([status])
  @@map("final_reports")
}

model Payment {
  id              String        @id @default(uuid())
  parentId        String
  parent          Parent        @relation(fields: [parentId], references: [id], onDelete: Cascade)
  type            PaymentType
  amount          Decimal       @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  paymentProof    String? // URL to uploaded file
  paymentDate     DateTime?
  dueDate         DateTime?
  confirmedBy     String? // Admin who confirmed
  confirmedAt     DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([parentId])
  @@index([type])
  @@index([status])
  @@index([dueDate])
  @@map("payments")
}

model PatientDocument {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  name        String
  type        String
  url         String
  uploadedBy  String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([patientId])
  @@map("patient_documents")
}

model ScheduleRequest {
  id                String              @id @default(uuid())
  parentId          String
  parent            Parent              @relation(fields: [parentId], references: [id], onDelete: Cascade)
  type              ScheduleRequestType
  reason            String
  newAvailability   Json?
  status            RequestStatus       @default(PENDING)
  adminResponse     String?
  respondedBy       String?
  respondedAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([parentId])
  @@index([status])
  @@map("schedule_requests")
}

// ========== ENUMS ==========

enum Gender {
  MALE
  FEMALE
  OTHER

  @@map("genders")
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY

  @@map("days_of_week")
}

enum ServiceType {
  EVALUATION
  TREATMENT

  @@map("service_types")
}

enum ConsultationType {
  CONSULTATION // Paid
  INTERVIEW    // Free

  @@map("consultation_types")
}

enum ConsultationStatus {
  PENDING
  PAYMENT_PENDING
  PAYMENT_CONFIRMED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("consultation_statuses")
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  REJECTED
  REFUNDED

  @@map("payment_statuses")
}

enum PaymentType {
  CONSULTATION
  PROPOSAL_FULL
  PROPOSAL_MONTHLY

  @@map("payment_types")
}

enum PaymentPlan {
  FULL
  MONTHLY

  @@map("payment_plans")
}

enum FormStatus {
  DRAFT
  COMPLETED

  @@map("form_statuses")
}

enum ProposalStatus {
  DRAFT
  SUBMITTED_TO_COORDINATOR
  COORDINATOR_APPROVED
  COORDINATOR_REJECTED
  SUBMITTED_TO_ADMIN
  ADMIN_APPROVED
  WAITING_PARENT_APPROVAL
  PARENT_APPROVED
  CANCELLED

  @@map("proposal_statuses")
}

enum ProposalType {
  A
  B

  @@map("proposal_types")
}

enum TreatmentPeriod {
  BIMONTHLY    // 2 months
  QUARTERLY    // 3 months
  FOUR_MONTHS  // 4 months
  BIANNUAL     // 6 months
  ANNUAL       // 12 months

  @@map("treatment_periods")
}

enum AssignmentStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("assignment_statuses")
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED

  @@map("session_statuses")
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  COORDINATOR_APPROVED
  COORDINATOR_REJECTED
  ADMIN_APPROVED
  SENT_TO_PARENT

  @@map("report_statuses")
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED

  @@map("request_statuses")
}

enum ScheduleRequestType {
  RESCHEDULE_SESSION
  RESCHEDULE_ALL
  CANCEL_SESSION
  CHANGE_THERAPIST

  @@map("schedule_request_types")
}

